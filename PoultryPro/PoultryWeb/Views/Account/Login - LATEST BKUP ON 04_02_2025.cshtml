@model PoultryWeb.Models.Authentication.Login.LoginModel

@{
    ViewData["Title"] = "Login";
    Layout = "_AuthLayout.cshtml";
}

<style>
    body {
        font-family: 'Roboto', sans-serif;
        display: flex;
        justify-content: center;
        margin: 0;
        /*background-color: #f5f5f5;*/
        background-color: #e3f2fd; /* Light blue background */
    }

    .login-container {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 350px;
        width: 100%;
        text-align: center;
        margin: auto;
        margin-bottom: 15%;
    }

    .login-container img {
        margin-bottom: 20px;
    }

    .login-container h2 {
        margin-bottom: 20px;
        font-size: 1.5rem;
        color: #333;
    }

    .login-container .form-group {
        margin-bottom: 15px;
        text-align: left;
    }

    .login-container .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .login-container .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-family: 'Roboto', sans-serif;
    }

    .login-container .form-group label, 
    .login-container .form-group a {
        display: inline-block;
    }

    .login-container .form-group a {
        float: right;
        font-size: 0.9rem;
        margin-top: -10px;
    }

    .login-container .form-check {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .login-container .form-check input {
        margin-right: 10px;
    }

    .login-container .btn-primary {
        background-color: #febd69;
        border-color: #f0ad4e;
        color: #333;
        padding: 10px;
        border-radius: 5px;
        font-size: 1rem;
        width: 100%;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .login-container .btn-primary:hover {
        background-color: #e2a937;
    }

    .login-container .btn-secondary {
        background-color: #e7e7e7;
        border-color: #ddd;
        color: #333;
        padding: 10px;
        border-radius: 5px;
        font-size: 1rem;
        width: 100%;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-top: 5px;
    }

    .login-container .btn-secondary:hover {
        background-color: #d7d7d7;
    }

    .login-container .btn-link {
        color: #007bff;
        text-decoration: none;
        font-size: 0.9rem;
        /*float: right;*/
    }

    .login-container .btn-link:hover {
        text-decoration: underline;
    }

    .login-container .footer-text {
        margin-top: 20px;
        font-size: 0.9rem;
        color: #666;
    }

    .login-container .footer-text a {
        color: #007bff;
        text-decoration: none;
    }

    .login-container .footer-text a:hover {
        text-decoration: underline;
    }
</style>

<div class="login-container">
   @* <img src="https://via.placeholder.com/100" alt="Logo" />*@
    <h3 style="text-align: center">Sign In</h3>
    <form data-bind="submit: login">
        <div class="form-group">
            <label for="Username">Username</label>
            <input type="text" id="Username" name="Username" class="form-control" data-bind="value: username, valueUpdate: 'input'" required>
            <span class="text-danger" data-bind="visible: usernameError, text: usernameErrorMessage"></span>
        </div>

        <div class="form-group">
            <label for="Password">Password</label>
            <input type="password" id="Password" name="Password" class="form-control" data-bind="value: password, valueUpdate: 'input'" required>
            <span class="text-danger" data-bind="visible: passwordError, text: passwordErrorMessage"></span>
        </div>

        <div class="form-check">
            <input type="checkbox" id="ShowPassword" class="form-check-input" data-bind="checked: showPassword">
            <label for="ShowPassword" class="form-check-label">Show password</label>
        </div>

        <div class="form-check">
            <input type="checkbox" id="RememberMe" name="RememberMe" class="form-check-input" data-bind="checked: rememberMe">
            <label for="RememberMe" class="form-check-label">Remember Me.</label>
        </div>

        <button type="submit" class="btn btn-primary">Sign In</button>
        
        <a href="@Url.Action("ForgotPassword", "Account")" class="btn-link">Forgot password?</a>

        <button type="button" class="btn btn-secondary" onclick="location.href='@Url.Action("Register", "Account")'">Don't have an account? Register Now!</button>
    </form>
    <div class="footer-text">
        <p><a href="@Url.Action("TermsOfService", "Home")">Terms of Service</a> | <a href="@Url.Action("Privacy", "Home")">Privacy</a></p>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-min.js"></script>
    <script>
        function ViewModel() {
            var self = this;

            self.username = ko.observable('');
            self.password = ko.observable('');
            self.rememberMe = ko.observable(true);
            self.showPassword = ko.observable(false);

            self.loginFailed = ko.observable(false);
            self.errorMessage = ko.observable('');

            self.usernameError = ko.computed(function() {
                var username = self.username();
                return !username;
            });

            self.passwordError = ko.computed(function() {
                return !self.password();
            });

            self.usernameError = ko.observable(false);
            self.passwordError = ko.observable(false);

            self.usernameErrorMessage = ko.observable('Please enter a valid username.');
            self.passwordErrorMessage = ko.observable('Password is required.');

            self.validateUsername = function() {
                self.usernameError(!self.username());
            };

            self.validatePassword = function() {
                self.passwordError(!self.password());
            };

            self.login = function(formElement) {
                // Perform client-side validation
                self.validateUsername();
                self.validatePassword();

                if (!self.passwordError()) {
                    // Submit form or make AJAX call here
                    // Example AJAX POST
                    $.ajax({
                        url: '@Url.Action("Login", "Account")', // Ensure the URL is correctly targeted to your application's URL structure
                        type: 'POST',
                        contentType: 'application/json',
                        data: ko.toJSON({ username: self.username, password: self.password, rememberMe: self.rememberMe }),
                        success: function(result) {
                            if (result.isSuccess) {
                                if (result.requiresTwoFactor) {
                                    // Redirect to OTP verification page
                                    var otpUrl = '@Url.Action("VerifyOtp", "Account")' + '?userId=' + result.userId + '&userName=' + result.userName;
                                    window.location.href = otpUrl;
                                } else {
                                    // Redirect to home page on successful login
                                    window.location.href = '@Url.Action("Index", "Home")';
                                }
                            } else {
                                self.loginFailed(true);
                                self.errorMessage(result.message || 'Invalid login attempt.');
                            }
                        },
                        error: function() {
                            self.loginFailed(true);
                            self.errorMessage('Error processing your login.');
                        }
                    });
                } else {
                    self.loginFailed(true);
                    self.errorMessage('Please check your entries and try again.');
                }
            };

            self.showPassword.subscribe(function(newValue) {
                var passwordInput = document.getElementById('Password');
                if (newValue) {
                    passwordInput.type = 'text';
                } else {
                    passwordInput.type = 'password';
                }
            });
        }

        ko.applyBindings(new ViewModel());
    </script>
}
