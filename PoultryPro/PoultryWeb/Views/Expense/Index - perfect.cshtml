@model IEnumerable<PoultryWeb.Models.ExpenseModel>

@{
    ViewBag.Title = "Expense Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .expense-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .table-section {
        flex: 1 1 100%;
        min-width: 300px;
        padding: 20px;
    }

    .bottom-bar {
        text-align: center;
        padding: 15px;
        border-top: 1px solid #ddd;
    }

    .modal-lg {
        max-width: 800px;
    }

    .filter-form {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: end;
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 1rem;
    }

    .table-responsive {
        max-height: 500px;
        overflow-y: auto;
    }
</style>

<div class="expense-container">
    <div class="table-section">
        <h2>Expense Management</h2>

        <form id="filterForm" class="filter-form row">
            <div class="col-md-3">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate" class="form-control" />
            </div>
            <div class="col-md-3">
                <label for="endDate">End Date</label>
                <input type="date" id="endDate" class="form-control" />
            </div>
            <div class="col-md-3">
                <label for="categoryFilter">Category</label>
                <input type="text" id="categoryFilter" class="form-control" placeholder="Enter category" />
            </div>
            <div class="col-md-2">
                <label>&nbsp;</label>
                <button type="button" class="btn btn-primary w-100" onclick="applyFilter()">View</button>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped expense-table" id="expenseTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr data-expense-id="@item.ExpenseId">
                            <td>@item.ExpenseDate.ToShortDateString()</td>
                            <td>@item.Category</td>
                            <td>@item.Amount.ToString("F2")</td>
                            <td>@item.PaymentMethod</td>
                            <td>
                                <button class="btn btn-danger btn-sm"
                                        onclick="event.stopPropagation(); confirmDelete(@item.ExpenseId)">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="bottom-bar">
    <button class="btn btn-primary btn-create" onclick="openCreateExpense()">
        <i class="bi bi-plus-circle"></i> Create New Expense
    </button>
</div>

<!-- Modal -->
<div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="expenseModalLabel">Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="editContainer">
                <!-- Partial content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const table = new DataTable('#expenseTable', {
                pageLength: 10,
                scrollY: '300px',
                scrollCollapse: true,
                ordering: true
            });

            document.getElementById('expenseTable').addEventListener('click', function (e) {
                var row = e.target.closest('tr[data-expense-id]');
                if (row && !e.target.closest('.btn-danger')) {
                    var expenseId = row.getAttribute('data-expense-id');
                    loadEditPartial(expenseId);
                }
            });
        });

        function applyFilter() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const category = document.getElementById('categoryFilter').value.toLowerCase();

            const rows = document.querySelectorAll('#expenseTable tbody tr');
            rows.forEach(row => {
                const date = row.children[0].textContent;
                const cat = row.children[1].textContent.toLowerCase();
                const show = (!start || new Date(date) >= new Date(start)) &&
                             (!end || new Date(date) <= new Date(end)) &&
                             (!category || cat.includes(category));
                row.style.display = show ? '' : 'none';
            });
        }

        function openCreateExpense() {
            fetch('/Expense/CreatePartial')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('expenseModalLabel').innerText = 'Create Expense';
                    document.getElementById('editContainer').innerHTML = html;
                    var modal = new bootstrap.Modal(document.getElementById('expenseModal'));
                    modal.show();
                });
        }

        function loadEditPartial(expenseId) {
            fetch('/Expense/EditPartial/' + expenseId)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('expenseModalLabel').innerText = 'Edit Expense (ID: ' + expenseId + ')';
                    document.getElementById('editContainer').innerHTML = html;
                    var modal = new bootstrap.Modal(document.getElementById('expenseModal'));
                    modal.show();
                });
        }

        function loadDeletePartial(expenseId) {
            fetch('/Expense/DeletePartial/' + expenseId)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('expenseModalLabel').innerText = 'Delete Expense';
                    document.getElementById('editContainer').innerHTML = html;
                    var modal = new bootstrap.Modal(document.getElementById('expenseModal'));
                    modal.show();
                });
        }

        function confirmDelete(expenseId) {
            loadDeletePartial(expenseId);
        }
    </script>
}
