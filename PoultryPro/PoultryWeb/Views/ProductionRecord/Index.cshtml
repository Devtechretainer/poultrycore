@model IEnumerable<PoultryWeb.Models.ProductionRecordViewModel>

@{
    ViewBag.Title = "Production Records";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .prod-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }

    .table-section {
        flex: 1 1 100%;
        min-width: 300px;
        padding: 20px;
    }

    .bottom-bar {
        text-align: center;
        padding: 15px;
        border-top: 1px solid #ddd;
    }

    .modal-lg {
        max-width: 1000px;
    }

    .filter-form {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 1rem;
        align-items: flex-end;
        width: 100%;
        gap: .75rem 1rem;
    }

        .filter-form label {
            margin-right: 0.5rem;
            white-space: nowrap;
        }

        .filter-form .form-control {
            display: inline-block;
            width: auto;
        }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter {
        display: inline-block;
        margin-right: 1rem;
    }

    .dataTables_wrapper .dataTables_length {
        float: left;
    }

    .dataTables_wrapper .dataTables_filter {
        float: right;
    }

    .table-responsive {
        max-height: 560px;
        overflow-y: auto;
    }
</style>

<div class="prod-container">
    <div class="table-section">
        <!-- Filter Toolbar -->
        <form id="filterForm" class="filter-form row w-100">
            <div class="col-md-2 d-flex align-items-center">
                <label for="startDate" class="me-2">From:</label>
                <input type="date" id="startDate" class="form-control" />
            </div>
            <div class="col-md-2 d-flex align-items-center">
                <label for="endDate" class="me-2">To:</label>
                <input type="date" id="endDate" class="form-control" />
            </div>
            <div class="col-md-1 d-flex align-items-center" style="margin-right:  5%">
                <label for="ageFilter" class="me-2">Age (wks)</label>
                <input type="number" id="ageFilter" class="form-control" placeholder="e.g. 1" min="0" />
            </div>
            <div class="col-md-1 d-flex align-items-center">
                <label for="medFilter" class="me-2">Meds</label>
                <input type="text" id="medFilter" class="form-control" placeholder="Contains..." />
                <button type="button" class="btn btn-primary me-2" onclick="applyFilter()">View</button>
            </div>
            <div class="col-md-4 d-flex justify-content-end align-items-center">
                <button type="button" class="btn btn-success me-2" onclick="exportCSV()">Export CSV</button>
                <button type="button" class="btn btn-danger" onclick="exportPDF()">Export PDF</button>
            </div>
        </form>


        <!-- Data Table -->
        <div class="table-responsive">
            <table class="table table-striped" id="prodTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" class="toggle-col" data-col="0" checked /> Age (wks)</th>
                        <th><input type="checkbox" class="toggle-col" data-col="1" checked /> Date</th>
                        <th><input type="checkbox" class="toggle-col" data-col="2" checked /> Birds</th>
                        <th><input type="checkbox" class="toggle-col" data-col="3" checked /> Mortality</th>
                        <th><input type="checkbox" class="toggle-col" data-col="4" checked /> Birds Left</th>
                        <th><input type="checkbox" class="toggle-col" data-col="5" checked /> Feed (Kg)</th>
                        <th><input type="checkbox" class="toggle-col" data-col="6" checked /> Medication</th>
                        <th><input type="checkbox" class="toggle-col" data-col="7" checked /> 9AM</th>
                        <th><input type="checkbox" class="toggle-col" data-col="8" checked /> 12PM</th>
                        <th><input type="checkbox" class="toggle-col" data-col="9" checked /> 4PM</th>
                        <th><input type="checkbox" class="toggle-col" data-col="10" checked /> Total Prod</th>
                        <th><input type="checkbox" class="toggle-col" data-col="11" checked /> Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model)
                    {
                        <tr data-record-id="@r.Id">
                            <td>@r.AgeInWeeks</td>
                            <td>@r.Date.ToShortDateString()</td>
                            <td>@r.NoOfBirds</td>
                            <td>@r.Mortality</td>
                            <td>@r.NoOfBirdsLeft</td>
                            <td>@r.FeedKg.ToString("F2")</td>
                            <td>@r.Medication</td>
                            <td>@r.Production9AM</td>
                            <td>@r.Production12PM</td>
                            <td>@r.Production4PM</td>
                            <td>@r.TotalProduction</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1"
                                        onclick="event.stopPropagation(); openEdit(@r.Id)">
                                    Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="event.stopPropagation(); openDelete(@r.Id)">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="2" class="text-end">Totals (visible rows):</th>
                        <th id="totBirds">0</th>
                        <th id="totMort">0</th>
                        <th id="totLeft">0</th>
                        <th id="totFeed">0.00</th>
                        <th></th>
                        <th id="tot9">0</th>
                        <th id="tot12">0</th>
                        <th id="tot4">0</th>
                        <th id="totProd">0</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="bottom-bar">
    <button class="btn btn-primary" onclick="openCreate()">
        <i class="bi bi-plus-circle"></i> Create New Production Record
    </button>
</div>

<!-- Modal -->
<div class="modal fade" id="prodModal" tabindex="-1" aria-labelledby="prodModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prodModalLabel">Production Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="prodEditContainer">
                <!-- Partial content will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        let prodTable;

        document.addEventListener('DOMContentLoaded', function () {
            prodTable = new DataTable('#prodTable', {
                pageLength: 10,
                scrollY: '380px',
                scrollCollapse: true,
                ordering: true,
                drawCallback: function () {
                    updateTotals();
                }
            });

            // Toggle columns
            document.querySelectorAll('.toggle-col').forEach(cb => {
                cb.addEventListener('change', function () {
                    const column = prodTable.column(this.dataset.col);
                    column.visible(this.checked);
                });
            });

            // Row click -> open edit
            document.getElementById('prodTable').addEventListener('click', function (e) {
                const btn = e.target.closest('button');
                if (btn) return;
                const row = e.target.closest('tr[data-record-id]');
                if (row) {
                    openEdit(row.getAttribute('data-record-id'));
                }
            });
        });

        // Filter rows
        function applyFilter() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const age = document.getElementById('ageFilter').value;
            const med = document.getElementById('medFilter').value.toLowerCase();

            const rows = document.querySelectorAll('#prodTable tbody tr');
            rows.forEach(row => {
                const dateText = row.children[1].textContent;
                const ageVal = row.children[0].textContent;
                const medVal = row.children[6].textContent.toLowerCase();

                const inDate =
                    (!start || new Date(dateText) >= new Date(start)) &&
                    (!end || new Date(dateText) <= new Date(end));
                const inAge = (!age || parseInt(ageVal || '0') === parseInt(age));
                const inMed = (!med || medVal.includes(med));

                row.style.display = (inDate && inAge && inMed) ? '' : 'none';
            });

            updateTotals();
        }

        // Helper parsers
        function parseCellInt(text) {
            const v = parseInt(text.replace(/,/g, ''), 10);
            return isNaN(v) ? 0 : v;
        }
        function parseCellDec(text) {
            const v = parseFloat(text.replace(/,/g, ''));
            return isNaN(v) ? 0 : v;
        }

        // Update totals in footer
        function updateTotals() {
            let birds=0, mort=0, left=0, feed=0, p9=0, p12=0, p4=0, total=0;

            document.querySelectorAll('#prodTable tbody tr').forEach(row => {
                if (row.style.display !== 'none') {
                    birds += parseCellInt(row.children[2].textContent);
                    mort  += parseCellInt(row.children[3].textContent);
                    left  += parseCellInt(row.children[4].textContent);
                    feed  += parseCellDec(row.children[5].textContent);
                    p9    += parseCellInt(row.children[7].textContent);
                    p12   += parseCellInt(row.children[8].textContent);
                    p4    += parseCellInt(row.children[9].textContent);
                    total += parseCellInt(row.children[10].textContent);
                }
            });

            document.getElementById('totBirds').innerText = birds.toLocaleString();
            document.getElementById('totMort').innerText  = mort.toLocaleString();
            document.getElementById('totLeft').innerText  = left.toLocaleString();
            document.getElementById('totFeed').innerText  = feed.toFixed(2);
            document.getElementById('tot9').innerText     = p9.toLocaleString();
            document.getElementById('tot12').innerText    = p12.toLocaleString();
            document.getElementById('tot4').innerText     = p4.toLocaleString();
            document.getElementById('totProd').innerText  = total.toLocaleString();
        }

        // Modal functions
        function openCreate() {
            fetch('/ProductionRecord/CreatePartial')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('prodModalLabel').innerText = 'Create Production Record';
                    document.getElementById('prodEditContainer').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('prodModal')).show();
                });
        }
        function openEdit(id) {
            fetch('/ProductionRecord/EditPartial/' + id)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('prodModalLabel').innerText = 'Edit Production Record (ID: ' + id + ')';
                    document.getElementById('prodEditContainer').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('prodModal')).show();
                });
        }
        function openDelete(id) {
            fetch('/ProductionRecord/DeletePartial/' + id)
                .then(res => res.text())
                .then(html => {
                    document.getElementById('prodModalLabel').innerText = 'Delete Production Record';
                    document.getElementById('prodEditContainer').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('prodModal')).show();
                });
        }

        // Export CSV
        function exportCSV() {
            let csv = "data:text/csv;charset=utf-8," +
                ["AgeInWeeks","Date","NoOfBirds","Mortality","NoOfBirdsLeft","FeedKg","Medication","Production9AM","Production12PM","Production4PM","TotalProduction"].join(",") + "\n";

            document.querySelectorAll('#prodTable tbody tr').forEach(row => {
                if (row.style.display !== 'none') {
                    const cols = Array.from(row.children).slice(0, 11).map(td => {
                        const t = td.textContent.trim().replace(/"/g, '""');
                        return /[",\n]/.test(t) ? `"${t}"` : t;
                    });
                    csv += cols.join(",") + "\n";
                }
            });

            const link = document.createElement("a");
            link.href = encodeURI(csv);
            link.download = "ProductionRecords.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export PDF
        function exportPDF() {
            const doc = new jspdf.jsPDF();
            doc.text("Production Records", 20, 10);

            const head = [["Age","Date","Birds","Mort.","Left","Feed(Kg)","Medication","9AM","12PM","4PM","Total"]];
            const body = [];
            document.querySelectorAll('#prodTable tbody tr').forEach(row => {
                if (row.style.display !== 'none') {
                    const cols = Array.from(row.children).slice(0, 11).map(td => td.textContent.trim());
                    body.push(cols);
                }
            });

            doc.autoTable({ head, body, startY: 16 });
            doc.save("ProductionRecords.pdf");
        }
    </script>
}
